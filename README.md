# spectralNotify

This project was created with [Better-T-Stack](https://github.com/AmanVarshney01/create-better-t-stack), a modern TypeScript stack that combines React, TanStack Router, Hono, ORPC, and more.

## Features

- **TypeScript** - For type safety and improved developer experience
- **TanStack Router** - File-based routing with full type safety
- **React Native** - Build mobile apps using React
- **Expo** - Tools for React Native development
- **TailwindCSS** - Utility-first CSS for rapid UI development
- **shadcn/ui** - Reusable UI components
- **Hono** - Lightweight, performant server framework
- **oRPC** - End-to-end type-safe APIs with OpenAPI integration
- **workers** - Runtime environment
- **Drizzle** - TypeScript-first ORM
- **SQLite/Turso** - Database engine
- **Authentication** - Better-Auth
- **Turborepo** - Optimized monorepo build system

## Getting Started

First, install the dependencies:

```bash
pnpm install
```
## Database Setup

This project uses SQLite with Drizzle ORM.

1. Start the local SQLite database:
D1 local development and migrations are handled automatically by Alchemy during dev and deploy.

2. Update your `.env` file in the `apps/server` directory with the appropriate connection details if needed.

3. Apply the schema to your database:
```bash
pnpm db:push
```


Then, run the development server:

```bash
pnpm dev
```

Open [http://localhost:3014](http://localhost:3014) in your browser to see the web application.
Use the Expo Go app to run the mobile application.
The API is running at [http://localhost:8094](http://localhost:8094).




## Before Deploying to Cloudflare

When you are ready to deploy your app to Cloudflare Workers, you'll have to make a couple changes.
- Change your url environment variables to match your `*.workers.dev` domains generated by Cloudflare:

```bash
# apps/web/.env
SERVER_URL={your-production-server-domain}

# apps/server/.env
CORS_ORIGIN={your-production-web-domain}
BETTER_AUTH_URL={your-production-server-domain}
```
- In `apps/server/src/lib/auth.ts`, uncomment the `session.cookieCache` and `advanced.crossSubDomainCookies` sections and replace `<your-workers-subdomain>` with your actual workers subdomain. These settings are required to ensure cookies are transferred properly between your web and server domains.



## Deployment (Alchemy)
- Dev: `pnpm cf:dev` (or `pnpm dev`)
- Deploy: `pnpm cf:deploy --profile dev` (and optionally `--stage <stage>`)
- Destroy: `pnpm cf:destroy --profile dev`

Notes:
- `--profile` selects Alchemy credentials; `--stage` selects the target environment name (defaults to your username).
- Deploys include a content-based `BUILD_ID`/`VITE_BUILD_ID` binding so Worker updates are applied even when only application code changes.
- Verify a deploy:
  - `https://notify.spectralgo.com/?__build=1` (shows `build <id>` overlay) or View Source for `<meta name="build-id" ...>`.


## Project Structure

```
spectralNotify/
├── apps/
│   ├── web/         # Frontend application (React + TanStack Router)
│   ├── native/      # Mobile application (React Native, Expo)
│   └── server/      # Backend API (Hono, ORPC)
├── packages/
│   ├── api/         # API layer / business logic
│   ├── auth/        # Authentication configuration & logic
│   └── db/          # Database schema & queries
```

## Available Scripts

### Development

| Command | Description |
|---------|-------------|
| `pnpm dev` | Start all applications in development mode (web, server, native) |
| `pnpm dev:web` | Start only the web application |
| `pnpm dev:server` | Start only the server |
| `pnpm dev:native` | Start the React Native/Expo development server |

### Build & Types

| Command | Description |
|---------|-------------|
| `pnpm build` | Build all applications for production |
| `pnpm check-types` | Run TypeScript type checking across all apps |
| `pnpm check` | Run Biome linter and formatter across the codebase |

### Database Management

| Command | Description |
|---------|-------------|
| `pnpm db:push` | Push schema changes to the database |
| `pnpm db:generate` | Generate new migration files from schema changes |
| `pnpm db:studio` | Open Drizzle Studio UI (default config) |
| `pnpm db:studio:local` | Open Drizzle Studio for local Miniflare D1 database |
| `pnpm db:studio:remote` | Open Drizzle Studio for remote Cloudflare D1 database |
| `pnpm db:clear` | Clear all data from local D1 database |
| `pnpm db:clear:remote` | Clear all data from remote D1 database (with confirmation) |

#### Database Clear Scripts

**What:** Scripts to delete all rows from all tables in the D1 database.

**Why:** Useful for resetting the database during development, testing, or when you need a clean slate without dropping/recreating the schema.

**How:**
- `pnpm db:clear` - Connects to the local Miniflare SQLite database and deletes all rows from all tables in foreign-key-safe order.
- `pnpm db:clear:remote` - Connects to the remote Cloudflare D1 database via HTTP API. Requires confirmation before executing to prevent accidental data loss.

Tables are cleared in this order to respect foreign key constraints:
1. `session`, `account` (depend on user)
2. `verification`, `idempotency_keys`
3. `task_registry`, `workflow_registry`, `counter_registry`
4. `user` (cleared last)

**Prerequisites for remote clearing:**
- `CLOUDFLARE_ACCOUNT_ID` - Your Cloudflare account ID
- `DATABASE_ID` - The D1 database ID
- `CLOUDFLARE_READ_API_TOKEN` - API token with D1 read/write permissions

These should be set in `apps/server/.env`.

### Durable Object Migrations

| Command | Description |
|---------|-------------|
| `pnpm counter:generate` | Generate migrations for Counter Durable Object schema |
| `pnpm task:generate` | Generate migrations for Task Durable Object schema |
| `pnpm workflow:generate` | Generate migrations for Workflow Durable Object schema |

### Deployment

| Command | Description |
|---------|-------------|
| `pnpm deploy` | Deploy all applications to Cloudflare Workers via Alchemy |
| `pnpm destroy` | Tear down deployed Cloudflare resources |
