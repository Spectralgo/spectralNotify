# Counter Durable Object Migrations

This directory contains SQL migrations for the Counter Durable Object's SQLite storage.

## Overview

Counter Durable Objects use **isolated SQLite databases** (one per DO instance). Unlike the main D1 database, these migrations:
- Are applied at runtime when each DO instance initializes
- Use Drizzle ORM's `durable-sqlite` adapter
- Are automatically generated by Drizzle Kit

## Directory Structure

```
counter-migrations/
├── generated/                          # Drizzle Kit output
│   ├── 0000_*.sql                     # Migration SQL files
│   ├── meta/                          # Migration metadata
│   │   ├── _journal.json              # Migration history
│   │   └── 0000_snapshot.json         # Schema snapshots
│   └── migrations.js                  # Migration manifest (auto-generated)
└── README.md                          # This file
```

## Creating New Migrations

### Automated Workflow (Recommended)

Use the provided shell script that handles everything:

```bash
cd apps/server
pnpm counter:migrate
```

This script will:
1. Run `drizzle-kit generate` to create SQL migration files
2. Generate the `migrations.js` manifest file
3. Update the migration index

### Manual Workflow

If you prefer to run steps manually:

1. **Update the schema** in `apps/server/src/counter-schema.ts`

2. **Generate migrations:**
   ```bash
   cd apps/server
   pnpm counter:generate
   ```

3. **Create the migrations.js manifest:**
   The manifest file should import all SQL files and the journal:
   ```javascript
   // generated/migrations.js
   import journal from "./meta/_journal.json";
   import m0000 from "./0000_init_counter.sql";
   import m0001 from "./0001_add_feature.sql";

   export default {
     journal,
     migrations: {
       m0000,
       m0001
     }
   };
   ```

## How Migrations Work

1. **Build time:** Drizzle Kit generates SQL files based on schema changes
2. **Runtime:** When a Counter DO instance is created:
   - The constructor imports `migrations.js`
   - Calls `migrate(db, migrations)` from `drizzle-orm/durable-sqlite/migrator`
   - Drizzle applies any pending migrations to the instance's SQLite database

## Important Notes

- **Each DO instance has its own database:** Migrations run independently per instance
- **Migrations are automatic:** They run on DO initialization via `ctx.blockConcurrencyWhile()`
- **Keep generated/ in git:** The generated migrations need to be committed
- **Don't edit SQL manually:** Always use Drizzle Kit to generate migrations

## Schema File

The Counter schema is defined in `apps/server/src/counter-schema.ts`:
- `counterMetadata`: Stores counter name, value, and metadata
- `counterHistory`: Audit log of all counter operations

## Configuration

Drizzle Kit configuration is in `apps/server/drizzle.config.counter.ts`:
```typescript
{
  schema: "./src/counter-schema.ts",
  out: "./src/counter-migrations/generated",
  dialect: "sqlite"
}
```
