# Task Durable Object Migrations

This directory contains SQLite migrations for Task Durable Objects.

## Overview

Task Durable Objects use Drizzle ORM with SQLite storage. Each task instance runs its own isolated SQLite database within the Durable Object.

## Schema

### taskMetadata Table
Stores the main task information (one row per task):
- `id` - Primary key (always 1)
- `taskId` - Task identifier
- `status` - Task status (pending, in-progress, success, failed, canceled)
- `progress` - Progress percentage (0-100)
- `createdAt` - Creation timestamp
- `updatedAt` - Last update timestamp
- `completedAt` - Completion timestamp
- `failedAt` - Failure timestamp
- `canceledAt` - Cancellation timestamp
- `metadata` - JSON metadata

### taskHistory Table
Stores event history (multiple rows):
- `id` - Auto-increment primary key
- `eventType` - Event type (log, progress, error, success)
- `message` - Event message
- `progress` - Optional progress value
- `timestamp` - Event timestamp
- `metadata` - Optional JSON metadata

## Migration Workflow

### 1. Generate Migrations

```bash
# From project root
pnpm task:generate
```

This runs Drizzle Kit to generate SQL migration files based on `task-schema.ts`.

### 2. Create Migration Manifest

```bash
# From project root
pnpm task:migrate
```

This script:
1. Generates migration SQL (if schema changed)
2. Creates `migrations.js` manifest
3. Packages migrations for runtime use

### 3. Apply Migrations

Migrations are automatically applied when:
- A Task Durable Object is created for the first time
- An existing Task DO starts up (idempotent)

The Task DO constructor runs:
```typescript
ctx.blockConcurrencyWhile(async () => {
  await migrate(this.db, migrations);
});
```

## Directory Structure

```
task-migrations/
├── README.md                    # This file
└── generated/                   # Generated by Drizzle Kit
    ├── 0000_public_old_lace.sql # Migration SQL
    ├── migrations.js            # Runtime manifest
    └── meta/
        ├── _journal.json        # Migration journal
        └── 0000_snapshot.json   # Schema snapshot
```

## Adding New Migrations

1. **Modify Schema**
   Edit `apps/server/src/task-schema.ts`:
   ```typescript
   export const taskMetadata = sqliteTable("task_metadata", {
     // Add new column
     newField: text("new_field"),
   });
   ```

2. **Generate Migration**
   ```bash
   pnpm task:generate
   ```

3. **Review SQL**
   Check `generated/000X_name.sql`

4. **Update Manifest**
   ```bash
   pnpm task:migrate
   ```

5. **Test Locally**
   ```bash
   pnpm dev
   ```

6. **Deploy**
   ```bash
   pnpm deploy
   ```

## Important Notes

- Each Task DO instance has its own SQLite database
- Migrations run independently per DO instance
- Schema changes require redeployment
- No data is shared between Task DO instances
- The registry table (D1) is separate and tracks all tasks

## Comparison with Counter Migrations

| Aspect | Counter | Task |
|--------|---------|------|
| Schema File | `counter-schema.ts` | `task-schema.ts` |
| Config | `drizzle.config.counter.ts` | `drizzle.config.task.ts` |
| Script | `counter-migrate.sh` | `task-migrate.sh` |
| Generate | `pnpm counter:generate` | `pnpm task:generate` |
| Migrate | `pnpm counter:migrate` | `pnpm task:migrate` |
| Tables | 2 (metadata, history) | 2 (metadata, history) |

## Troubleshooting

### migrations.js Not Found

Run the migration script:
```bash
pnpm task:migrate
```

### Migration Not Applied

Check DO initialization:
```typescript
// In task.ts constructor
ctx.blockConcurrencyWhile(async () => {
  await this._migrate();
});
```

### Schema Out of Sync

1. Delete generated/ folder
2. Run `pnpm task:generate`
3. Run `pnpm task:migrate`

## Resources

- [Drizzle Kit Docs](https://orm.drizzle.team/kit-docs/overview)
- [Drizzle SQLite Docs](https://orm.drizzle.team/docs/get-started-sqlite)
- [Durable Objects SQLite](https://developers.cloudflare.com/durable-objects/api/transactional-storage-api/#sqlite-storage-backend)
